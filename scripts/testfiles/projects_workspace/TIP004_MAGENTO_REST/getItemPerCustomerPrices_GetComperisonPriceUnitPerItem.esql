

CREATE DATABASE MODULE getItemPerCustomerPrices_GetComperisonPriceUnitPerItem
	CREATE FUNCTION Main() RETURNS BOOLEAN
	BEGIN
		CREATE FIELD Environment.Variables.ALUNS;
		DECLARE m3Ref, m3Cursor REFERENCE TO Environment.Variables.ALUNS;

		DECLARE m3query CHAR
		'
		SELECT 
		TRIM(MUITNO) AS ITNO,
		TRIM(MUALUN) AS ALUN
		FROM MITAUN
		WHERE MUCONO=100 
			AND MUAUTP=1
			AND MUALUN IN (''KG'',''L'')
			AND MUITNO NOT IN (
								SELECT MUITNO
								FROM MITAUN
								WHERE MUCONO = 100
									AND MUAUTP = 1
									AND MUALUN IN (''KG'',''L'')
								GROUP BY MUITNO
								HAVING COUNT(*) > 1
								)
		UNION
		SELECT 
		TRIM(MUITNO) AS ITNO,
		TRIM(MUALUN) AS ALUN
		FROM MITAUN
		WHERE MUCONO=100 
			AND MUAUTP=1
			AND MUALUN IN (''KG'',''L'')
			AND MUITNO IN (
							SELECT MUITNO
							FROM MITAUN
							WHERE MUCONO = 100
								AND MUAUTP = 1
								AND MUALUN IN (''KG'',''L'')
							GROUP BY MUITNO
							HAVING COUNT(*) > 1
							)
			AND MUAUS6 = ''1''
		';
		SET m3Ref.Item[] = PASSTHRU(m3query);
	END;
END MODULE;
