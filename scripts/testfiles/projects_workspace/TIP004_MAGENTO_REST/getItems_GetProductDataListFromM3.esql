

CREATE DATABASE MODULE getItems_GetProductDataListFromM3
	CREATE FUNCTION Main() RETURNS BOOLEAN
	BEGIN
		DECLARE productsQuery CHAR '
			SELECT
				TRIM(MM.MMITNO) AS ITNO,
				MM.MMSTAT AS STAT,
				MM.MMNEWE AS NEWE,
				TRIM(MM.MMSPE1) AS SPE1,
				MM.MMITTY AS ITTY,
				TRIM(MM.MMITCL) AS ITCL,
				TRIM(MM.MMUNMS) AS UNMS,
				TRIM(COALESCE(MA.MUALUN, MM.MMUNMS)) AS ALUN,
				MA.MUCOFA AS COFA,
				TRIM(MA2.MUALUN) AS COMP_SALES_UNIT,
				TRIM(MA3.MUALUN) AS SALES_PRICE_UNIT,
				TRIM(MP.MPPOPN) AS POPN,
				TRIM(COALESCE(MD.MDITDS, MM.MMITDS)) AS ITDS,
				TRIM(COALESCE(MD.MDFUDS, MM.MMFUDS)) AS FUDS
			FROM
				MITMAS AS MM
			LEFT JOIN MITAUN AS MA 
				ON MM.MMITNO=MA.MUITNO 
				AND MA.MUAUS2 = ''1'' 
				AND MA.MUAUTP = ''1''
				AND MA.MUCONO = MM.MMCONO
			LEFT JOIN MITAUN AS MA2 
				ON MM.MMITNO = MA2.MUITNO 
				AND MA2.MUAUTP = ''2''
				AND TRIM(MA2.MUALUN) IN (''KG'', ''L'')
				AND MA2.MUCONO = MM.MMCONO
				AND MA2.MUAUS6 = ''1''
			LEFT JOIN MITAUN AS MA3 
				ON MM.MMITNO = MA3.MUITNO 
				AND MA3.MUAUS9 = ''1'' 
				AND MA3.MUAUTP = ''2'' 
				AND MA3.MUCONO = MM.MMCONO
			LEFT JOIN MITPOP AS MP 
				ON MMITNO = MPITNO 
				AND MP.MPALWT = 1 
				AND MP.MPREMK = ''EPD'' 
				AND MP.MPCONO = MM.MMCONO
			LEFT JOIN MITLAD AS MD 
				ON MD.MDCONO= MM.MMCONO 
				AND MD.MDITNO= MM.MMITNO
				AND MD.MDLNCD=''NO''
			WHERE
				MM.MMSALE = 1
				AND MM.MMCONO = 100
			';
		
		IF Environment.Variables.SKU IS NOT NULL THEN
			SET productsQuery = productsQuery || ' AND MMITNO = ?';
			SET Environment.Variables.ProductList.Product[] = 
			PASSTHRU(productsQuery 
			VALUES (Environment.Variables.SKU));
		ELSE
			SET Environment.Variables.ProductList.Product[] = PASSTHRU(productsQuery);
		END IF;
		
		PROPAGATE TO TERMINAL 'out1';
		--PROPAGATE TO TERMINAL 'out';
		
		RETURN TRUE;
	END;

END MODULE;
